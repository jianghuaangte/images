name: Sync Docker Images

on:
  schedule:
    - cron: '15 2 * * *'
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Install Git LFS
      run: |
        sudo apt-get update
        sudo apt-get install -y git-lfs
        git lfs install

    - name: Docker Login (optional)
      if: false  # å¦‚æœéœ€è¦ç™»å½•ç§æœ‰ä»“åº“ï¼Œè®¾ä¸º true å¹¶é…ç½® secrets
      run: |
        echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin

    - name: åŒæ­¥ Docker é•œåƒ
      id: sync_docker
      run: |
        set -e
        # è¿™é‡Œé…ç½®ä½ çš„é•œåƒ
        IMAGE_CONFIG=(
          "cloudnas/clouddrive2:latest:docker-images/clouddrive2"
          "stilleshan/frpc:latest:docker-images/frpc"
        )

        needs_commit=false

        for config in "${IMAGE_CONFIG[@]}"; do
          IFS=':' read -r IMAGE TAG TARGET_DIR <<< "$config"
          IMAGE_FULL="$IMAGE:$TAG"
          SAFE_NAME="${IMAGE//\//_}__$TAG"
          TAG_FILE="$TARGET_DIR/latest.tag"

          mkdir -p "$TARGET_DIR"

          echo "ğŸ”„ æ­£åœ¨æ‹‰å–é•œåƒ: $IMAGE_FULL"
          docker pull "$IMAGE_FULL" > docker_pull.log 2>&1

          # è·å–é•œåƒ ID
          NEW_IMAGE_ID=$(docker inspect --format='{{.Id}}' "$IMAGE_FULL")
          CURRENT_ID=$(cat "$TAG_FILE" 2>/dev/null || echo "")

          if [[ "$NEW_IMAGE_ID" == "$CURRENT_ID" ]]; then
            echo "âœ… é•œåƒæœªå˜æ›´: $IMAGE_FULL"
            continue
          fi

          echo "ğŸ†• é•œåƒæœ‰æ›´æ–°ï¼Œå‡†å¤‡å¯¼å‡º: $IMAGE_FULL"

          # æ¸…ç©ºæ—§æ–‡ä»¶å¹¶å¯¼å‡ºæ–° tar æ–‡ä»¶
          rm -rf "${TARGET_DIR:?}/"*
          TAR_FILE="$TARGET_DIR/image.tar"
          docker save "$IMAGE_FULL" -o "$TAR_FILE"

          echo "$NEW_IMAGE_ID" > "$TAG_FILE"
          needs_commit=true

          echo "âœ”ï¸ å¯¼å‡ºå®Œæˆ: $TAR_FILE"
        done

        echo "needs_commit=$needs_commit" >> $GITHUB_OUTPUT

    - name: Commit and Push Changes
      if: steps.sync_docker.outputs.needs_commit == 'true'
      run: |
        git config --global user.name "GitHub Actions Bot"
        git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
        
        git add -A
        if [ -n "$(git status --porcelain)" ]; then
          git commit -m "chore: æ›´æ–° Docker é•œåƒ tar åŒ… [skip ci]"
          git push origin main
          echo "ğŸš€ å˜æ›´å·²æäº¤"
        else
          echo "ğŸ”„ æ— éœ€æäº¤"
        fi
